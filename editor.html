<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portfolio √âvolutif ‚Äî √âditeur (Algorithmique & Complexit√©)</title>
  <style>
    :root{
      --bg:#ffffff; --muted:#f6f8fa; --card:#fbfcfd;
      --accent:#2563eb; --text:#0f1724; --muted-text:#58666f;
      --danger:#e11d48; --radius:10px; --shadow: 0 6px 18px rgba(16,24,40,0.06);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;}
    .wrap{display:flex;gap:20px;min-height:100vh;padding:20px;box-sizing:border-box;}
    .sidebar{width:320px;max-width:40%;background:var(--muted);padding:14px;border-radius:var(--radius);box-shadow:var(--shadow);display:flex;flex-direction:column;gap:12px;}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#60a5fa);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;}
    h1{font-size:16px;margin:0}
    .muted{color:var(--muted-text);font-size:13px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button{background:var(--accent);color:white;border:0;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600;}
    button.ghost{background:transparent;color:var(--text);border:1px solid rgba(10,10,10,0.05)}
    .list{overflow:auto;padding-right:6px}
    .lesson-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:var(--card);cursor:pointer;margin-bottom:8px}
    .lesson-item.active{outline:2px solid rgba(37,99,235,0.12);background:#eef6ff}
    .lesson-title{font-weight:700}
    .meta{font-size:12px;color:var(--muted-text)}
    .trash{background:transparent;border:0;color:var(--danger);cursor:pointer;border-radius:6px;padding:6px}
    .main{flex:1;min-width:0;display:flex;flex-direction:column;gap:12px}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:var(--shadow)}
    .page-top{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    input.title{font-size:20px;font-weight:700;border:0;background:transparent;outline:none;width:70%}
    label.field-label{font-weight:700;margin-bottom:6px;display:block}
    textarea.field{width:100%;min-height:100px;padding:10px;border-radius:8px;border:1px solid rgba(10,10,10,0.06);resize:vertical;font-size:15px;font-family:inherit;box-sizing:border-box;background:white}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .small{font-size:13px;color:var(--muted-text)}
    footer.note{font-size:13px;color:var(--muted-text);text-align:right}
    @media (max-width:900px){.wrap{padding:12px}.sidebar{display:none}.page-top{flex-direction:column}.input.title{width:100%}}
    .tools{display:flex;gap:8px;align-items:center}
    .file-input{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <aside class="sidebar" id="sidebar">
      <div>
        <div class="brand">
          <div class="logo">AC</div>
          <div>
            <h1>Portfolio ‚Äî √âditeur</h1>
            <div class="muted">Algorithmique & Complexit√© ‚Äî mode √©tudiant</div>
          </div>
        </div>

        <div class="controls" style="margin-top:10px;">
          <button id="btnAdd">Ajouter une le√ßon</button>
          <button class="ghost" id="btnVisitor">Voir en mode visiteur</button>
        </div>

        <div style="margin-top:8px;font-size:13px;color:var(--muted-text)">Le√ßons</div>
      </div>

      <div class="list card" id="list" style="padding:10px;max-height:55vh"></div>

      <div class="card" style="display:flex;flex-direction:column;gap:8px;padding:12px">
        <div style="display:flex;gap:8px">
          <button id="btnExport">Exporter JSON</button>
          <label class="ghost" style="padding:8px;border-radius:8px;cursor:pointer">
            Importer JSON
            <input type="file" id="fileImport" class="file-input" accept=".json">
          </label>
        </div>
        <div style="display:flex;gap:8px">
          <button id="btnExportHtml" class="ghost">Exporter HTML imprimable</button>
          <button id="btnClear" class="ghost" style="color:var(--danger);border-color:rgba(225,29,72,0.08)">R√©initialiser (vider)</button>
        </div>
        <div class="small">Les modifications sont automatiquement sauvegard√©es dans votre navigateur.</div>
      </div>
    </aside>

    <main class="main" id="main">
      <div class="card">
        <div class="page-top">
          <div style="display:flex;flex-direction:column;gap:4px">
            <input id="titleInput" class="title" placeholder="S√©lectionnez ou cr√©ez une le√ßon..." />
            <div class="small" id="subtitle">‚Äî</div>
          </div>
          <div class="tools">
            <button id="btnPrintLesson" class="ghost">Aper√ßu imprimable</button>

         
            <button id="btnPublish" style="background:var(--accent);color:white;">Enregistrer & Publier</button>

            <button id="btnDelete" class="ghost" style="color:var(--danger);border-color:rgba(225,29,72,0.08);display:none">Supprimer</button>
          </div>
        </div>
      </div>

      <div id="content"></div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Bilan Final</h3>
        <div class="small" style="margin-bottom:8px;color:var(--muted-text)">Compl√©tez ces 4 sections pour votre synth√®se finale.</div>
        <label class="field-label">Ce que j‚Äôai le plus appris dans ce cours</label>
        <textarea id="b_appris" class="field"></textarea>

        <label class="field-label" style="margin-top:10px">Les comp√©tences que je peux r√©utiliser ailleurs</label>
        <textarea id="b_comp" class="field"></textarea>

        <label class="field-label" style="margin-top:10px">Mon plus grand d√©fi</label>
        <textarea id="b_defis" class="field"></textarea>

        <label class="field-label" style="margin-top:10px">Mes prochaines √©tapes d'apprentissage</label>
        <textarea id="b_next" class="field"></textarea>
      </div>

      <footer class="note">Cl√© locale: <span id="storageKey"></span></footer>
    </main>
  </div>

  <script>
    const STORAGE_KEY = 'ac_portfolio_v2';
    document.getElementById('storageKey').textContent = STORAGE_KEY;

    let store = { lessons: [], bilan: { appris:'', competences:'', defis:'', prochaines:'' } , selected: null };
    let saveTimer = null, SAVE_DELAY = 400;

    function uid(){ return 'l_' + Date.now().toString(36) + '_' + Math.floor(Math.random()*9000+1000).toString(36); }

    function saveLesson(id){
      const l = store.lessons.find(x => x.id === id);
      if (!l) return;
      l.updatedAt = Date.now();
      scheduleSave();
      renderList();
    }
    window.saveLesson = saveLesson;

    function deleteLesson(id){
      const idx = store.lessons.findIndex(x => x.id === id);
      if (idx === -1) return;
      if (!confirm('Supprimer cette le√ßon ?')) return;
      store.lessons.splice(idx,1);
      if (store.selected === id) store.selected = store.lessons.length ? store.lessons[0].id : null;
      scheduleSave();
      renderList();
      renderMain();
    }
    window.deleteLesson = deleteLesson;

    function loadLessons(){
      loadData();
      return store.lessons;
    }
    window.loadLessons = loadLessons;

    function saveBilan(){
      store.bilan.appris = document.getElementById('b_appris').value;
      store.bilan.competences = document.getElementById('b_comp').value;
      store.bilan.defis = document.getElementById('b_defis').value;
      store.bilan.prochaines = document.getElementById('b_next').value;
      scheduleSave();
    }
    window.saveBilan = saveBilan;

    function loadBilan(){
      const b = store.bilan || {};
      document.getElementById('b_appris').value = b.appris || '';
      document.getElementById('b_comp').value = b.competences || '';
      document.getElementById('b_defis').value = b.defis || '';
      document.getElementById('b_next').value = b.prochaines || '';
      return b;
    }
    window.loadBilan = loadBilan;

    function switchMode(mode){
      if (mode === 'visitor') window.location.href = './index.html';
      else alert('switchMode: seul "visitor" est g√©r√© (redirection vers index.html)');
    }
    window.switchMode = switchMode;

    function scheduleSave(){
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(() => { localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); saveTimer = null; }, SAVE_DELAY);
      renderSubtitleSaved();
    }

    function saveNow(){
      if (saveTimer) clearTimeout(saveTimer);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
      saveTimer = null;
      renderSubtitleSaved();
    }
    window.saveNow = saveNow;

    function loadData(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw){
        try {
          const parsed = JSON.parse(raw);
          store = Object.assign({ lessons: [], bilan:{}, selected: null }, parsed);
          if (!Array.isArray(store.lessons)) store.lessons = [];
        } catch(e){
          store = { lessons: [], bilan:{}, selected: null };
        }
      } else {
        const id = uid();
        store.lessons = [{
          id, title: 'Le√ßon 1 ‚Äî Introduction',
          journal:'', synthese:'', application:'', maitrise:'', ameliorer:'', strategie:'', updatedAt: Date.now()
        }];
        store.selected = id;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
      }
      renderList();
      renderMain();
      loadBilan();
    }

    const listEl = document.getElementById('list');
    const titleInput = document.getElementById('titleInput');
    const subtitle = document.getElementById('subtitle');
    const content = document.getElementById('content');
    const btnDelete = document.getElementById('btnDelete');

    function renderList(){
      listEl.innerHTML = '';
      store.lessons.forEach(l => {
        const div = document.createElement('div');
        div.className = 'lesson-item' + (store.selected === l.id ? ' active' : '');
        div.tabIndex = 0;
        div.onclick = () => { store.selected = l.id; renderMain(); };
        const left = document.createElement('div');
        left.style.display = 'flex'; left.style.flexDirection='column';
        const t = document.createElement('div'); t.className='lesson-title'; t.textContent = l.title || 'Le√ßon';
        const m = document.createElement('div'); m.className='meta'; m.textContent = l.updatedAt ? 'Modifi√© ' + new Date(l.updatedAt).toLocaleString() : '';
        left.appendChild(t); left.appendChild(m);
        const right = document.createElement('div');
        const del = document.createElement('button'); del.className='trash'; del.title='Supprimer'; del.innerHTML='üóë';
        del.onclick = (e) => { e.stopPropagation(); deleteLesson(l.id); };
        right.appendChild(del);
        div.appendChild(left); div.appendChild(right);
        listEl.appendChild(div);
      });

      const bilan = document.createElement('div'); 
      bilan.className='lesson-item' + (store.selected === 'bilan' ? ' active' : '');
      bilan.style.marginTop='8px'; bilan.tabIndex=0;
      bilan.innerHTML = '<div><div class="lesson-title">Bilan Final</div><div class="meta">Synth√®se finale</div></div>';
      bilan.onclick = () => { store.selected = 'bilan'; renderMain(); };
      listEl.appendChild(bilan);
    }

    function renderMain(){
      if (store.selected === 'bilan'){
        titleInput.value = 'Bilan Final';
        titleInput.readOnly = true;
        subtitle.textContent = '√âditez le bilan ci-dessous';
        btnDelete.style.display = 'none';
        content.innerHTML = '<div class="card small">Acc√©dez au Bilan Final dans la section "Bilan Final" plus bas sur la page.</div>';
        loadBilan();
        return;
      }
      const l = store.lessons.find(x => x.id === store.selected) || store.lessons[0];
      if (!l){
        content.innerHTML = '<div class="card small">Aucune le√ßon disponible. Cr√©ez-en une.</div>';
        titleInput.value = '';
        titleInput.readOnly = true;
        subtitle.textContent = '‚Äî';
        btnDelete.style.display = 'none';
        return;
      }
      store.selected = l.id;
      titleInput.readOnly = false;
      titleInput.value = l.title || '';
      subtitle.textContent = l.updatedAt ? 'Derni√®re modification: ' + new Date(l.updatedAt).toLocaleString() : '';
      btnDelete.style.display = 'inline-block';
      btnDelete.onclick = () => deleteLesson(l.id);

      content.innerHTML = '';

      const c1 = document.createElement('div'); c1.className='card';
      c1.innerHTML = '<label class="field-label">Journal d\'apprentissage r√©flexif</label><div class="small" style="margin-bottom:8px;color:var(--muted-text)">√âcrivez 5‚Äì10 lignes.</div><textarea class="field" data-field="journal"></textarea>';

      const c2 = document.createElement('div'); c2.className='card';
      c2.innerHTML = '<label class="field-label">Synth√®se personnelle des concepts cl√©s</label><textarea class="field" data-field="synthese"></textarea>';

      const c3 = document.createElement('div'); c3.className='card';
      c3.innerHTML = '<label class="field-label">Application pratique</label><textarea class="field" data-field="application"></textarea>';

      const c4 = document.createElement('div'); c4.className='card';
      c4.innerHTML = '<label class="field-label">Auto-√©valuation</label><div class="grid-2" style="margin-top:8px;"><div><label class="field-label">Ce que je ma√Ætrise :</label><textarea class="field" data-field="maitrise"></textarea></div><div><label class="field-label">√Ä am√©liorer :</label><textarea class="field" data-field="ameliorer"></textarea></div></div><div style="margin-top:12px;"><label class="field-label">Strat√©gie :</label><textarea class="field" data-field="strategie"></textarea></div>';

      content.appendChild(c1); 
      content.appendChild(c2); 
      content.appendChild(c3); 
      content.appendChild(c4);

      titleInput.oninput = () => { 
        l.title = titleInput.value; 
        l.updatedAt = Date.now(); 
        scheduleSave(); 
        renderList(); 
      };

      const areas = content.querySelectorAll('textarea.field');
      areas.forEach(a => {
        const f = a.getAttribute('data-field');
        a.value = l[f] || '';
        a.oninput = () => {
          l[f] = a.value;
          l.updatedAt = Date.now();
          scheduleSave();
          subtitle.textContent = 'Derni√®re modification: ' + new Date(l.updatedAt).toLocaleString();
          renderList();
        };
      });
    }

    let savedHintTimer = null;
    function renderSubtitleSaved(){
      subtitle.textContent = 'Modifications en attente...';
      if (savedHintTimer) clearTimeout(savedHintTimer);
      savedHintTimer = setTimeout(() => {
        subtitle.textContent = 'Enregistr√© localement';
      }, SAVE_DELAY + 120);
    }

    document.getElementById('btnAdd').onclick = () => {
      const id = uid();
      const count = store.lessons.length + 1;
      const l = { id, title: `Le√ßon ${count}`, journal:'', synthese:'', application:'', maitrise:'', ameliorer:'', strategie:'', updatedAt: Date.now() };
      store.lessons.push(l);
      store.selected = id;
      scheduleSave();
      renderList();
      renderMain();
    };

    document.getElementById('btnVisitor').onclick = () => { switchMode('visitor'); };

    document.getElementById('btnExport').onclick = () => {
      const blob = new Blob([JSON.stringify(store, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'portfolio_ac_export.json'; a.click();
      URL.revokeObjectURL(url);
    };

    document.getElementById('fileImport').onchange = (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = () => {
        try {
          const parsed = JSON.parse(r.result);
          if (!confirm('Importer va remplacer les donn√©es locales. Continuer ?')) return;
          store = Object.assign({lessons:[],bilan:{},selected:null}, parsed);
          if (!Array.isArray(store.lessons)) store.lessons = [];
          scheduleSave();
          renderList();
          renderMain();
          loadBilan();
        } catch (err){ alert('Fichier JSON invalide'); }
      };
      r.readAsText(f);
      e.target.value = '';
    };

    document.getElementById('btnExportHtml').onclick = () => {
      const sel = store.selected;
      if (!sel || sel === 'bilan'){
        const win = window.open('', '_blank');
        win.document.write(makePrintableHtml(store));
        win.document.close();
      } else {
        const l = store.lessons.find(x=>x.id===sel);
        const win = window.open('', '_blank');
        win.document.write(makePrintableHtml({ lessons:[l], bilan: store.bilan }));
        win.document.close();
      }
    };

    document.getElementById('btnPrintLesson').onclick = () => {
      const sel = store.selected;
      if (!sel || sel === 'bilan'){ alert('S√©lectionnez une le√ßon'); return; }
      const l = store.lessons.find(x=>x.id===sel);
      const win = window.open('', '_blank');
      win.document.write(makePrintableHtml({ lessons:[l], bilan: store.bilan }, { title: l.title }));
      win.document.close();
    };

    document.getElementById('btnClear').onclick = () => {
      if (!confirm('Effacer toutes les donn√©es ?')) return;
      store = { lessons: [], bilan:{}, selected:null };
      localStorage.removeItem(STORAGE_KEY);
      renderList();
      renderMain();
      loadBilan();
    };

   
    document.getElementById('btnPublish').onclick = () => {
      saveNow();
      alert("Votre le√ßon a √©t√© publi√©e !");
      window.location.href = './index.html';
    };

    function makePrintableHtml(payload, options = {}) {
      const css = `
        body{font-family:Arial;color:#111;margin:28px}
        .card{border:1px solid #e6eefc;padding:18px;border-radius:8px;margin-bottom:14px}
        h1{font-size:20px;margin-bottom:8px}
        h2{font-size:16px;margin:0 0 8px 0}
        p{margin:6px 0;white-space:pre-wrap}
      `;
      const title = options.title || 'Portfolio ‚Äî Algorithmique & Complexit√©';
      let body = `<h1>${escapeHtml(title)}</h1>`;
      payload.lessons.forEach((l, i) => {
        body += `<div class="card"><h2>${escapeHtml(l.title)}</h2>`;
        body += `<strong>Journal</strong><p>${escapeHtml(l.journal)}</p>`;
        body += `<strong>Synth√®se</strong><p>${escapeHtml(l.synthese)}</p>`;
        body += `<strong>Application</strong><p>${escapeHtml(l.application)}</p>`;
        body += `<strong>Maitrise</strong><p>${escapeHtml(l.maitrise)}</p>`;
        body += `<strong>Am√©liorer</strong><p>${escapeHtml(l.ameliorer)}</p>`;
        body += `<strong>Strat√©gie</strong><p>${escapeHtml(l.strategie)}</p>`;
        body += `</div>`;
      });
      const b = payload.bilan || {};
      body += `<div class="card"><h2>Bilan Final</h2>`;
      body += `<strong>Ce que j‚Äôai appris</strong><p>${escapeHtml(b.appris)}</p>`;
      body += `<strong>Comp√©tences</strong><p>${escapeHtml(b.competences)}</p>`;
      body += `<strong>D√©fi</strong><p>${escapeHtml(b.defis)}</p>`;
      body += `<strong>√âtapes</strong><p>${escapeHtml(b.prochaines)}</p>`;
      body += `</div>`;
      return `<!doctype html><html><head><meta charset="utf-8"><style>${css}</style></head><body>${body}</body></html>`;
    }

    function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }


    loadData();

  </script>
</body>
</html>
